#!/bin/bash

# ==============================================
#  GitHub Auto-Uploader Pro v2.0
# ==============================================
# Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„ÙƒÙˆØ¯:
# 1. ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¢Ù…Ù† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Token
# 2. ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ Ù…Ù„Ù log
# 3. Ø¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù€ crontab
# 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø°ÙƒÙŠØ© Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
# 5. ØªØ£Ù…ÙŠÙ† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©
# 6. Ø¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
# ==============================================

# ðŸ”§ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
TOKEN_FILE="/storage/emulated/0/1/.git_token"
PROJECT_DIR="/storage/emulated/0/1"
REPO_URL="https://github.com/kareemrouc1/my-website.git"
LOG_FILE="/storage/emulated/0/1/git_uploader.log"

# ðŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø³Ø¬Ù„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
[ ! -f "$LOG_FILE" ] && touch "$LOG_FILE"

# â° ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡
echo -e "\nðŸ”” [$(date +'%Y-%m-%d %H:%M:%S')] Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ†ÙÙŠØ°" >> "$LOG_FILE"

# ðŸ”’ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Token
if [ ! -f "$TOKEN_FILE" ]; then
    echo -e "âŒ Ø®Ø·Ø£: Ù…Ù„Ù Ø§Ù„ØªÙˆÙƒÙŠÙ† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯\nØ§Ù„Ø±Ø¬Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙˆÙƒÙŠÙ†" >> "$LOG_FILE"
    exit 1
fi

# ðŸ“‚ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ø³Ø§Ø±
cd "$PROJECT_DIR" || {
    echo "âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ $PROJECT_DIR" >> "$LOG_FILE"
    exit 1
}

# ðŸ”„ Ù…Ø¹Ø§Ù„Ø¬Ø© Git
GIT_TOKEN=$(cat "$TOKEN_FILE")
CHANGES=$(git status --porcelain)

if [ -n "$CHANGES" ]; then
    echo "ðŸ”„ ÙŠÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©:" >> "$LOG_FILE"
    echo "$CHANGES" >> "$LOG_FILE"
    
    # âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª
    git add . >> "$LOG_FILE" 2>&1
    
    # ðŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
    if git commit -m "ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ: $(date +'%Y-%m-%d %H:%M:%S')" >> "$LOG_FILE" 2>&1; then
        echo "âœ” ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª" >> "$LOG_FILE"
        
        # ðŸš€ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        if git push "https://$GIT_TOKEN@$REPO_URL" master >> "$LOG_FILE" 2>&1; then
            echo -e "âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­\n$(git log -1 --pretty='%h - %s (%cr)')" >> "$LOG_FILE"
        else
            echo "âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ GitHub" >> "$LOG_FILE"
            echo "ðŸ” Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©:" >> "$LOG_FILE"
            echo "1. Token Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©" >> "$LOG_FILE"
            echo "2. Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª" >> "$LOG_FILE"
            exit 1
        fi
    else
        echo "âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª" >> "$LOG_FILE"
        exit 1
    fi
else
    echo "âœ” Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©" >> "$LOG_FILE"
    
    # ðŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Ø£ÙŠ ØªØºÙŠÙŠØ±Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
    git fetch origin >> "$LOG_FILE" 2>&1
fi

# ðŸŽ‰ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
echo -e "ðŸ•’ [$(date +'%Y-%m-%d %H:%M:%S')] Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ù†Ø¬Ø§Ø­\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> "$LOG_FILE"
